<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>RMW desert: CBOR</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">RMW desert<span id="projectnumber">&#160;1.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">CBOR</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md4"></a>This is a minimalistic implementation for CBOR, the Concise Binary Object Representation. CBOR is defined by <a href="https://datatracker.ietf.org/doc/html/rfc8949">IETF RFC 8949</a>, and Wikipedia has <a href="https://en.wikipedia.org/wiki/CBOR">a good description</a>.</p>
<h1><a class="anchor" id="autotoc_md5"></a>
Features</h1>
<ul>
<li>C99</li>
<li>No dynamic memory allocation</li>
<li>Small code footprint</li>
</ul>
<h1><a class="anchor" id="autotoc_md6"></a>
Build</h1>
<h2><a class="anchor" id="autotoc_md7"></a>
Make</h2>
<div class="fragment"><div class="line">CBOR_ROOT ?= &lt;THIRD_PARTY_DIR&gt;/cbor</div>
<div class="line">include $(CBOR_ROOT)/cbor.mk</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md8"></a>
CMake</h2>
<div class="fragment"><div class="line">include(FetchContent)</div>
<div class="line">FetchContent_Declare(cbor</div>
<div class="line">                      GIT_REPOSITORY https://github.com/libmcu/cbor.git</div>
<div class="line">                      GIT_TAG main</div>
<div class="line">)</div>
<div class="line">FetchContent_MakeAvailable(cbor)</div>
</div><!-- fragment --><p>or</p>
<div class="fragment"><div class="line">set(CBOR_ROOT &lt;THIRD_PARTY_DIR&gt;/cbor)</div>
<div class="line">include(${CBOR_ROOT}/cbor.cmake)</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md9"></a>
Usage</h1>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> parse_cert(<span class="keyword">const</span> cbor_reader_t *reader,</div>
<div class="line">        <span class="keyword">const</span> <span class="keyword">struct</span> cbor_parser *parser,</div>
<div class="line">        <span class="keyword">const</span> cbor_item_t *item, <span class="keywordtype">void</span> *arg) {</div>
<div class="line">    <span class="keyword">struct </span>your_data_type *out = arg;</div>
<div class="line">    cbor_decode(reader, item, out-&gt;cert, <span class="keyword">sizeof</span>(out-&gt;cert));</div>
<div class="line">}</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> parse_key(<span class="keyword">const</span> cbor_reader_t *reader,</div>
<div class="line">        <span class="keyword">const</span> <span class="keyword">struct</span> cbor_parser *parser,</div>
<div class="line">        <span class="keyword">const</span> cbor_item_t *item, <span class="keywordtype">void</span> *arg) {</div>
<div class="line">    <span class="keyword">struct </span>your_data_type *out = arg;</div>
<div class="line">    cbor_decode(reader, item, out-&gt;key, <span class="keyword">sizeof</span>(out-&gt;key));</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span>cbor_parser parsers[] = {</div>
<div class="line">    { .key = <span class="stringliteral">&quot;certificate&quot;</span>, .run = parse_cert },</div>
<div class="line">    { .key = <span class="stringliteral">&quot;privateKey&quot;</span>,  .run = parse_key },</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">cbor_reader_t reader;</div>
<div class="line">cbor_item_t items[MAX_ITEMS];</div>
<div class="line"> </div>
<div class="line">cbor_reader_init(&amp;reader, items, <span class="keyword">sizeof</span>(items) / <span class="keyword">sizeof</span>(*items));</div>
<div class="line">cbor_unmarshal(&amp;reader, parsers, <span class="keyword">sizeof</span>(parsers) / <span class="keyword">sizeof</span>(*parsers),</div>
<div class="line">        msg, msglen, &amp;your_data_type);</div>
<div class="line"> </div>
<div class="line">...</div>
</div><!-- fragment --><p>Please refer to [examples](examples).</p>
<h2><a class="anchor" id="autotoc_md10"></a>
Option</h2>
<ul>
<li><code>CBOR_BIG_ENDIAN</code><ul>
<li>Define the macro for big endian machine. The default is little endian.</li>
</ul>
</li>
<li><code>CBOR_RECURSION_MAX_LEVEL</code><ul>
<li>This is set to avoid stack overflow from recursion. The default maximum depth is 8.</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md11"></a>
Parser</h2>
<p>The parser takes 626 bytes on ARM Cortex-M0 optimizing for code size <code>-Os</code>. <a href="https://developer.arm.com/-/media/Files/downloads/gnu-rm/10-2020q4/gcc-arm-none-eabi-10-2020-q4-major-src.tar.bz2?revision=8f69a18b-dbe3-45ec-b896-3ba56844938d&amp;hash=946C702B1C99A84CD0C441357D578E80B2A56EF9">arm-none-eabi-gcc 10-2020-q4-major</a> was used for the check.</p>
<p>Stack usage per the major type functions:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Major type   </th><th class="markdownTableHeadNone">Bytes    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">0: unsigned integer   </td><td class="markdownTableBodyNone">12    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">1: negative integer   </td><td class="markdownTableBodyNone">12    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">2: byte string   </td><td class="markdownTableBodyNone">32    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">3: text string   </td><td class="markdownTableBodyNone">32    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">4: array   </td><td class="markdownTableBodyNone">32    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">5: map   </td><td class="markdownTableBodyNone">32    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">6: tag(not implemented yet)   </td><td class="markdownTableBodyNone">0    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">7: floating-point numbers, simple values and break   </td><td class="markdownTableBodyNone">32   </td></tr>
</table>
<p>And the call stack for each recursion is 24 bytes.</p>
<div class="fragment"><div class="line">cbor_reader_t reader;</div>
<div class="line">cbor_item_t items[MAX_ITEMS];</div>
<div class="line"><span class="keywordtype">size_t</span> n;</div>
<div class="line"> </div>
<div class="line">cbor_reader_init(&amp;reader, items, <span class="keyword">sizeof</span>(items) / <span class="keyword">sizeof</span>(*items));</div>
<div class="line">cbor_parse(&amp;reader, cbor_message, cbor_message_len, &amp;n);</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">for</span> (i = 0; i &lt; n; i++) {</div>
<div class="line">    printf(<span class="stringliteral">&quot;item: %s, size: %zu\n&quot;</span>,</div>
<div class="line">            cbor_stringify_item(&amp;items[i]),</div>
<div class="line">            cbor_get_item_size(&amp;items[i]);</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md12"></a>
Decoder</h2>
<div class="fragment"><div class="line"><span class="keyword">union </span>{</div>
<div class="line">    int8_t i8;</div>
<div class="line">    int16_t i16;</div>
<div class="line">    int32_t i32;</div>
<div class="line">    int64_t i64;</div>
<div class="line">    <span class="keywordtype">float</span> f32;</div>
<div class="line">    <span class="keywordtype">double</span> f64;</div>
<div class="line">    uint8_t s[MTU];</div>
<div class="line">} val;</div>
<div class="line"> </div>
<div class="line">cbor_decode(&amp;reader, &amp;items[i], &amp;val, <span class="keyword">sizeof</span>(val));</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md13"></a>
Encoder</h2>
<div class="fragment"><div class="line">cbor_writer_t writer;</div>
<div class="line"> </div>
<div class="line">cbor_writer_init(&amp;reader, buf, <span class="keyword">sizeof</span>(buf));</div>
<div class="line"> </div>
<div class="line">cbor_encode_map(&amp;writer, 2);</div>
<div class="line">  <span class="comment">/* 1st */</span></div>
<div class="line">  cbor_encode_text_string(&amp;writer, <span class="stringliteral">&quot;key&quot;</span>);</div>
<div class="line">  cbor_encode_text_string(&amp;writer, <span class="stringliteral">&quot;value&quot;</span>);</div>
<div class="line">  <span class="comment">/* 2nd */</span></div>
<div class="line">  cbor_encode_text_string(&amp;writer, <span class="stringliteral">&quot;age&quot;</span>);</div>
<div class="line">  cbor_encode_negative_integer(&amp;writer, -1);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md14"></a>
Limitation</h1>
<ul>
<li>The maximum item length is <code>size_t</code> because the interface return type is <code>size_t</code>. The argument's value in the specification can go up to <code>uint64_t</code> though</li>
<li>A negative integer ranges down to -2^63-1 other than -2^64 in the specification</li>
<li>Sorting of encoded map keys is not supported</li>
<li>Tag item is not implemented yet</li>
<li><code>cbor_unmarshal()</code> only works on the major type 5: map with string key </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
